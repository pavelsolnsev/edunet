<!DOCTYPE html>
<html>
<head>
    <title>Примеры. Редактор многоугольника</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="referrer" content="always">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

</head>
<body class="container">
<h1 style="font-size: 22px">Заголовок H1</h1>
Поменять: <input type="text" id="h1" style="width: 50%" value="Заголовок H1" autocomplete="off" />
<p>URL: <script>document.write(document.URL)</script></p>
<p><a href="#" id="gen-url">Сгенереть URL</a></p>
<p><a href="#" id="gen-url-utm">Сгенереть URL c UTM</a></p>
<div style="background: #eee; margin-bottom: 1rem; padding: 1rem 1rem 0">
    <p style="font-size: 1.4em;">Подай лид!</p>
    <form id="ylead-frm" method="post" class="row" name="test-form" autocomplete="off" style="margin-bottom: 0;">
        <div class="col input-field s6 m4 l3" style="margin-bottom: 0">
            <input type="text" id="ylead-name" required pattern="[A-Za-zа-яА-ЯёЁ\s\-]{1,32}" class="validate">
            <label for="ylead-name">Имя</label>
            <span class="helper-text" data-error="Некорректное имя" data-success=""></span>
        </div>
        <div class="col input-field s6 m4 l3" style="margin-bottom: 0">
            <input type="tel" id="ylead-phone" pattern="\+?\d{1,3}\s?[\(]?\d{1,5}[\)]?\s?\d{4,12}"  required class="validate">
            <label for="ylead-phone">Телефон</label>
            <span class="helper-text" data-error="Некорректный телефон" data-success=""></span>
        </div>
        <div class="col input-field s6 m4 l3" style="margin-bottom: 0">
            <input type="email" id="ylead-email" required class="validate">
            <label for="ylead-email">Email</label>
            <span class="helper-text" data-error="Некорректный Email" data-success=""></span>
        </div>
        <div class="col input-field s6 m12 l3 center-align">
            <button class="btn" type="button">Отправить</button>
        </div>
    </form>
</div>
<textarea style="height: 300px" autocomplete="off"></textarea>
<script>
    $(function() {
        function randomString(i) {
            let rnd = '';
            while (rnd.length < i)
                rnd += Math.random().toString(36).substring(2);
            return rnd.substring(0, i);
        };
        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        const url='/dev/leads-fp.html?'
        let len=getRandomInt(5);
        let i, tUrl=url;
        for(i=0; i<len; i++) {
            tUrl+=randomString(6)+'='+randomString(15)+'&';
        }
        tUrl=tUrl.substr(0, tUrl.length-1);
        $("#gen-url").attr("href", tUrl);

        tUrl+='&utm_source=inner_source_'+randomString(3)+'&utm_campaign=inner_campaign_'+randomString(3)+'&utm_content='+randomString(10)+'&utm_term='+randomString(10);
        $("#gen-url-utm").attr("href", tUrl);

        $("#h1").on('keyup', function () {
            $('h1').text($("#h1").val());
        });

        if($("#ylead-frm").length) {

            $("#ylead-frm button").on("click", function() {
                const $frm=$(this).closest('form');
                let utms='';
                if(window.location.search.substring(1).includes('utm_source=')) {
                    utms+='utm_source=edunetwork_ads';
                } else {
                    utms+='utm_source=edunetwork_seo';
                }
                utms+='&utm_campaign='+$('h1').text().trim()+'&utm_term='+$($frm).attr('name');

                $("textarea").val($("textarea").val()+utms+"\n\n");
                const submitText=$("button", $frm).text();
                let a=true;
                $(".validate", $frm).each(function () {
                    if(!$(this).is(".valid")) {
                        M.toast({html: 'Не все поля заполнены корректно'});
                        a=false;
                        return false;
                    }
                });

                if(a) {
                    $("button", $frm).attr("disabled", "disabled").html("Отправка");
                    $.ajax({
                        type: 'POST',
                        url: '//mods.edunetwork.ru/ylead.php',
                        data: {
                            name:  $('#ylead-name').val().trim(),
                            email: $('#ylead-email').val().trim(),
                            phone: $('#ylead-phone').val().trim(),
                            utms: utms
                        },
                        success: function(msg) {
                            if(msg === 'Ok') {
                                M.toast({html: 'Заявка успешно отправлена'});
                                $("button", $frm).html('Готово!');
                            } else {
                                $("button", $frm).html(submitText).removeAttr("disabled");
                                if(msg.substr(0,3) === 'Err') {
                                    M.toast({html: msg.substr(4)});
                                } else { // wtf
                                    M.toast({html: 'Ошибка сервера'});
                                }
                            }
                        },
                        error:function() {
                            $("button", $frm).html(submitText).removeAttr("disabled");
                            M.toast({html: 'Ошибка сервера'});
                        }
                    });
                }
            });
        }
    });
</script>


</body>
</html>